(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5405],{8312:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return a(6027)}])},5417:function(e,t,a){"use strict";a.d(t,{h:function(){return IconButton}});var s=a(5893),n=a(8456);let IconButton=e=>{let{iconName:t,isProcessing:a,label:o,customIcon:r,...l}=e;return(0,s.jsxs)("button",{...l,className:"bg-primary hover:bg-primary-hover active:bg-primary-press disabled:bg-primary-disabled text-white rounded-16 text-sm p-8 text-center inline-flex items-center mr-2\n        ".concat(l.className,"\n      "),children:[a?(0,s.jsx)(n.Z,{size:24,color:"inherit"}):r||(0,s.jsx)("pixiv-icon",{name:t,scale:"1"}),o&&(0,s.jsx)("div",{className:"mx-4 font-bold",children:o})]})};IconButton.defaultProps={iconName:"24/Close"}},6027:function(e,t,a){"use strict";let s,n,o;a.r(t),a.d(t,{default:function(){return Home}});var r=a(5893),l=a(7294),i=a(9477),c=a(8893),d=a(7836);let u=new i.Pa4,h=new i._fP,p=new i.USm;let VRMLookAtSmoother=class VRMLookAtSmoother extends c.cw{update(e){if(this.target&&this.autoUpdate){this.lookAt(this.target.getWorldPosition(u));let t=this._yaw,a=this._pitch,s=t,n=a;if(this.userTarget){this.lookAt(this.userTarget.getWorldPosition(u)),(this.userLimitAngle<Math.abs(this._yaw)||this.userLimitAngle<Math.abs(this._pitch))&&(this._yaw=t,this._pitch=a);let o=1-Math.exp(-this.smoothFactor*e);this._yawDamped+=(this._yaw-this._yawDamped)*o,this._pitchDamped+=(this._pitch-this._pitchDamped)*o;let r=1-i.M8C.smoothstep(Math.sqrt(t*t+a*a),30,90);s=i.M8C.lerp(t,.6*this._yawDamped,r),n=i.M8C.lerp(a,.6*this._pitchDamped,r),p.set(-this._pitchDamped*i.M8C.DEG2RAD,this._yawDamped*i.M8C.DEG2RAD,0,c.cw.EULER_ORDER),h.setFromEuler(p);let l=this.humanoid.getRawBoneNode("head");this._tempFirstPersonBoneQuat.copy(l.quaternion),l.quaternion.slerp(h,.4),l.updateMatrixWorld()}this.enableSaccade&&(.5<this._saccadeTimer&&.05>Math.random()&&(this._saccadeYaw=(2*Math.random()-1)*5,this._saccadePitch=(2*Math.random()-1)*5,this._saccadeTimer=0),this._saccadeTimer+=e,s+=this._saccadeYaw,n+=this._saccadePitch,this.applier.applyYawPitch(s,n)),this._needsUpdate=!1}this._needsUpdate&&(this._needsUpdate=!1,this.applier.applyYawPitch(this._yaw,this._pitch))}revertFirstPersonBoneQuat(){if(this.userTarget){let e=this.humanoid.getNormalizedBoneNode("head");e.quaternion.copy(this._tempFirstPersonBoneQuat)}}constructor(e,t){super(e,t),this.smoothFactor=4,this.userLimitAngle=90,this._saccadeYaw=0,this._saccadePitch=0,this._saccadeTimer=0,this._yawDamped=0,this._pitchDamped=0,this._tempFirstPersonBoneQuat=new i._fP,this.enableSaccade=!0}};let VRMLookAtSmootherLoaderPlugin=class VRMLookAtSmootherLoaderPlugin extends c.Hn{get name(){return"VRMLookAtSmootherLoaderPlugin"}async afterRoot(e){await super.afterRoot(e);let t=e.userData.vrmHumanoid,a=e.userData.vrmLookAt;if(null!=t&&null!=a){let s=new VRMLookAtSmoother(t,a.applier);s.copy(a),e.userData.vrmLookAt=s}}};let LipSync=class LipSync{update(){this.analyser.getFloatTimeDomainData(this.timeDomainData);let e=0;for(let t=0;t<2048;t++)e=Math.max(e,Math.abs(this.timeDomainData[t]));return(e=1/(1+Math.exp(-45*e+5)))<.1&&(e=0),{volume:e}}async playFromArrayBuffer(e,t){let a=await this.audio.decodeAudioData(e),s=this.audio.createBufferSource();s.buffer=a,s.connect(this.audio.destination),s.connect(this.analyser),s.start(),t&&s.addEventListener("ended",t)}async playFromURL(e,t){let a=await fetch(e),s=await a.arrayBuffer();this.playFromArrayBuffer(s,t)}constructor(e){this.audio=e,this.analyser=e.createAnalyser(),this.timeDomainData=new Float32Array(2048)}};let AutoLookAt=class AutoLookAt{constructor(e,t){this._lookAtTarget=new i.Tme,t.add(this._lookAtTarget),e.lookAt&&(e.lookAt.target=this._lookAtTarget)}};let AutoBlink=class AutoBlink{setEnable(e){return(this._isAutoBlink=e,this._isOpen)?0:this._remainingTime}update(e){if(this._remainingTime>0){this._remainingTime-=e;return}if(this._isOpen&&this._isAutoBlink){this.close();return}this.open()}close(){this._isOpen=!1,this._remainingTime=.12,this._expressionManager.setValue("blink",1)}open(){this._isOpen=!0,this._remainingTime=5,this._expressionManager.setValue("blink",0)}constructor(e){this._expressionManager=e,this._remainingTime=0,this._isAutoBlink=!0,this._isOpen=!0}};let ExpressionController=class ExpressionController{playEmotion(e){var t,a,s,n,o;if("neutral"!=this._currentEmotion&&(null===(n=this._expressionManager)||void 0===n||n.setValue(this._currentEmotion,0)),"neutral"==e){null===(o=this._autoBlink)||void 0===o||o.setEnable(!0),this._currentEmotion=e;return}null===(t=this._autoBlink)||void 0===t||t.setEnable(!1),this._currentEmotion=e,null===(a=this._expressionManager)||void 0===a||a.setValue(c.bN.Blink,0),null===(s=this._expressionManager)||void 0===s||s.setValue(e,1);let r=1e3*this.getDelayTime(e);setTimeout(()=>{var t,a;null===(t=this._expressionManager)||void 0===t||t.setValue(e,0),null===(a=this._expressionManager)||void 0===a||a.setValue("neutral",1),this._currentEmotion="neutral"},r)}getDelayTime(e){switch(e){case"happy":case"relaxed":case"neutral":return 5;case"angry":case"sad":return 8;default:return 3}}lipSync(e,t){if(this._currentLipSync){var a;null===(a=this._expressionManager)||void 0===a||a.setValue(this._currentLipSync.preset,0)}this._currentLipSync={preset:e,value:t}}update(e){if(this._autoBlink&&this._autoBlink.update(e),this._currentLipSync){var t;let e="neutral"===this._currentEmotion?.5*this._currentLipSync.value:.25*this._currentLipSync.value;null===(t=this._expressionManager)||void 0===t||t.setValue(this._currentLipSync.preset,e)}}constructor(e,t){this._autoLookAt=new AutoLookAt(e,t),this._currentEmotion="neutral",this._currentLipSync=null,e.expressionManager&&(this._expressionManager=e.expressionManager,this._autoBlink=new AutoBlink(e.expressionManager))}};let EmoteController=class EmoteController{playEmotion(e){this._expressionController.playEmotion(e)}lipSync(e,t){this._expressionController.lipSync(e,t)}update(e){this._expressionController.update(e)}constructor(e,t){this._expressionController=new ExpressionController(e,t)}};let Model=class Model{async loadVRM(e){let t=new d.E;t.register(e=>new c.XX(e,{lookAtPlugin:new VRMLookAtSmootherLoaderPlugin(e)}));let a=await t.loadAsync(e),s=this.vrm=a.userData.vrm;s.scene.name="VRMRoot",c.ck.rotateVRM0(s),this.mixer=new i.Xcj(s.scene),this.emoteController=new EmoteController(s,this._lookAtTargetParent)}unLoadVrm(){this.vrm&&(c.ck.deepDispose(this.vrm.scene),this.vrm=null)}async loadAnimation(e){let{vrm:t,mixer:a}=this;if(null==t||null==a)throw Error("You have to load VRM first");let s=e.createAnimationClip(t),n=a.clipAction(s);n.play()}async speak(e,t){var a;null===(a=this.emoteController)||void 0===a||a.playEmotion(t.expression),await new Promise(t=>{var a;null===(a=this._lipSync)||void 0===a||a.playFromArrayBuffer(e,()=>{t(!0)})})}update(e){var t,a,s,n;if(this._lipSync){let{volume:e}=this._lipSync.update();null===(n=this.emoteController)||void 0===n||n.lipSync("aa",e)}null===(t=this.emoteController)||void 0===t||t.update(e),null===(a=this.mixer)||void 0===a||a.update(e),null===(s=this.vrm)||void 0===s||s.update(e)}constructor(e){this._lookAtTargetParent=e,this._lipSync=new LipSync(new AudioContext)}};let VRMAnimation=class VRMAnimation{createAnimationClip(e){let t=[];if(t.push(...this.createHumanoidTracks(e)),null!=e.expressionManager&&t.push(...this.createExpressionTracks(e.expressionManager)),null!=e.lookAt){let e=this.createLookAtTrack("lookAtTargetParent.quaternion");null!=e&&t.push(e)}return new i.m7l("Clip",this.duration,t)}createHumanoidTracks(e){var t,a;let s=e.humanoid,n=e.meta.metaVersion,o=[];for(let[e,a]of this.humanoidTracks.rotation.entries()){let r=null===(t=s.getNormalizedBoneNode(e))||void 0===t?void 0:t.name;if(null!=r){let e=new i.yC1("".concat(r,".quaternion"),a.times,a.values.map((e,t)=>"0"===n&&t%2==0?-e:e));o.push(e)}}for(let[e,t]of this.humanoidTracks.translation.entries()){let r=null===(a=s.getNormalizedBoneNode(e))||void 0===a?void 0:a.name;if(null!=r){let e=this.restHipsPosition.y,a=s.getNormalizedAbsolutePose().hips.position[1],l=a/e,i=t.clone();i.values=i.values.map((e,t)=>("0"===n&&t%3!=1?-e:e)*l),i.name="".concat(r,".position"),o.push(i)}}return o}createExpressionTracks(e){let t=[];for(let[a,s]of this.expressionTracks.entries()){let n=e.getExpressionTrackName(a);if(null!=n){let e=s.clone();e.name=n,t.push(e)}}return t}createLookAtTrack(e){if(null==this.lookAtTrack)return null;let t=this.lookAtTrack.clone();return t.name=e,t}constructor(){this.duration=0,this.restHipsPosition=new i.Pa4,this.humanoidTracks={translation:new Map,rotation:new Map},this.expressionTracks=new Map,this.lookAtTrack=null}};function arrayChunk(e,t){let a=e.length,s=[],n=[],o=0;for(let r=0;r<a;r++){let a=e[r];o<=0&&(o=t,n=[],s.push(n)),n.push(a),o--}return s}let m=new i.yGw,g=new i.Pa4,y=new i._fP,v=new i._fP,x=new i._fP;let VRMAnimationLoaderPlugin=class VRMAnimationLoaderPlugin{get name(){return"VRMC_vrm_animation"}async afterRoot(e){var t;let a=e.parser.json,s=a.extensionsUsed;if(null==s||-1==s.indexOf(this.name))return;let n=null===(t=a.extensions)||void 0===t?void 0:t[this.name];if(null==n)return;let o=this._createNodeMap(n),r=await this._createBoneWorldMatrixMap(e,n),l=n.humanoid.humanBones.hips.node,c=await e.parser.getDependency("node",l),d=c.getWorldPosition(new i.Pa4),u=e.animations,h=u.map((e,t)=>{let s=a.animations[t],n=this._parseAnimation(e,s,o,r);return n.restHipsPosition=d,n});e.userData.vrmAnimations=h}_createNodeMap(e){var t,a,s,n,o;let r=new Map,l=new Map,i=null===(t=e.humanoid)||void 0===t?void 0:t.humanBones;i&&Object.entries(i).forEach(e=>{let[t,a]=e,{node:s}=a;r.set(s,t)});let c=null===(a=e.expressions)||void 0===a?void 0:a.preset;c&&Object.entries(c).forEach(e=>{let[t,a]=e,{node:s}=a;l.set(s,t)});let d=null===(s=e.expressions)||void 0===s?void 0:s.custom;return d&&Object.entries(d).forEach(e=>{let[t,a]=e,{node:s}=a;l.set(s,t)}),{humanoidIndexToName:r,expressionsIndexToName:l,lookAtIndex:null!==(o=null===(n=e.lookAt)||void 0===n?void 0:n.node)&&void 0!==o?o:null}}async _createBoneWorldMatrixMap(e,t){e.scene.updateWorldMatrix(!1,!0);let a=await e.parser.getDependencies("node"),s=new Map;for(let[e,{node:r}]of Object.entries(t.humanoid.humanBones)){let t=a[r];if(s.set(e,t.matrixWorld),"hips"===e){var n,o;s.set("hipsParent",null!==(o=null===(n=t.parent)||void 0===n?void 0:n.matrixWorld)&&void 0!==o?o:m)}}return s}_parseAnimation(e,t,a,s){let n=e.tracks,o=t.channels,r=new VRMAnimation;return r.duration=e.duration,o.forEach((e,t)=>{let{node:o,path:l}=e.target,d=n[t];if(null==o)return;let u=a.humanoidIndexToName.get(o);if(null!=u){let e=c.j$[u];for(;null!=e&&null==s.get(e);)e=c.j$[e];if(null!=e||(e="hipsParent"),"translation"===l){let e=s.get("hipsParent"),t=arrayChunk(d.values,3).flatMap(t=>g.fromArray(t).applyMatrix4(e).toArray()),a=d.clone();a.values=new Float32Array(t),r.humanoidTracks.translation.set(u,a)}else if("rotation"===l){let t=s.get(u),a=s.get(e);y.setFromRotationMatrix(t).normalize().invert(),v.setFromRotationMatrix(a).normalize();let n=arrayChunk(d.values,4).flatMap(e=>x.fromArray(e).premultiply(v).multiply(y).toArray()),o=d.clone();o.values=new Float32Array(n),r.humanoidTracks.rotation.set(u,o)}else throw Error('Invalid path "'.concat(l,'"'));return}let h=a.expressionsIndexToName.get(o);if(null!=h){if("translation"===l){let e=d.times,t=new Float32Array(d.values.length/3);for(let e=0;e<t.length;e++)t[e]=d.values[3*e];let a=new i.dUE("".concat(h,".weight"),e,t);r.expressionTracks.set(h,a)}else throw Error('Invalid path "'.concat(l,'"'));return}if(o===a.lookAtIndex){if("rotation"===l)r.lookAtTrack=d;else throw Error('Invalid path "'.concat(l,'"'))}}),r}constructor(e,t){this.parser=e}};let f=new d.E;async function loadVRMAnimation(e){let t=await f.loadAsync(e),a=t.userData.vrmAnimations,s=a[0];return null!=s?s:null}f.register(e=>new VRMAnimationLoaderPlugin(e));var b=a(1752),C=a.n(b);function buildUrl(e){let{publicRuntimeConfig:t}=C()();return"".concat(t.root).concat(e)}var j=a(9365);let w=new class{loadVrm(e){var t;(null===(t=this.model)||void 0===t?void 0:t.vrm)&&this.unloadVRM(),this.model=new Model(this._camera||new i.Tme),this.model.loadVRM(e).then(async()=>{var e;if(!(null===(e=this.model)||void 0===e?void 0:e.vrm))return;this.model.vrm.scene.traverse(e=>{e.frustumCulled=!1}),this._scene.add(this.model.vrm.scene);let t=await loadVRMAnimation(buildUrl("/idle_loop.vrma"));t&&this.model.loadAnimation(t),requestAnimationFrame(()=>{this.resetCamera()})})}unloadVRM(){var e,t;(null===(e=this.model)||void 0===e?void 0:e.vrm)&&(this._scene.remove(this.model.vrm.scene),null===(t=this.model)||void 0===t||t.unLoadVrm())}setup(e){var t,a;let s=e.parentElement,n=(null==s?void 0:s.clientWidth)||e.width,o=(null==s?void 0:s.clientHeight)||e.height;this._renderer=new i.CP7({canvas:e,alpha:!0,antialias:!0}),this._renderer.setSize(n,o),this._renderer.setPixelRatio(window.devicePixelRatio),this._camera=new i.cPb(20,n/o,.1,20),this._camera.position.set(0,1.3,1.5),null===(t=this._cameraControls)||void 0===t||t.target.set(0,1.3,0),null===(a=this._cameraControls)||void 0===a||a.update(),this._cameraControls=new j.z(this._camera,this._renderer.domElement),this._cameraControls.screenSpacePanning=!0,this._cameraControls.update(),window.addEventListener("resize",()=>{this.resize()}),this.isReady=!0,this.update()}resize(){if(!this._renderer)return;let e=this._renderer.domElement.parentElement;e&&(this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(e.clientWidth,e.clientHeight),this._camera&&(this._camera.aspect=e.clientWidth/e.clientHeight,this._camera.updateProjectionMatrix()))}resetCamera(){var e,t,a,s,n;let o=null===(t=this.model)||void 0===t?void 0:null===(e=t.vrm)||void 0===e?void 0:e.humanoid.getNormalizedBoneNode("head");if(o){let e=o.getWorldPosition(new i.Pa4);null===(a=this._camera)||void 0===a||a.position.set(this._camera.position.x,e.y,this._camera.position.z),null===(s=this._cameraControls)||void 0===s||s.target.set(e.x,e.y,e.z),null===(n=this._cameraControls)||void 0===n||n.update()}}constructor(){this.update=()=>{requestAnimationFrame(this.update);let e=this._clock.getDelta();this.model&&this.model.update(e),this._renderer&&this._camera&&this._renderer.render(this._scene,this._camera)},this.isReady=!1;let e=new i.xsS;this._scene=e;let t=new i.Ox3(16777215,2);t.position.set(1,1,1).normalize(),e.add(t);let a=new i.Mig(16777215,1);e.add(a),this._clock=new i.SUY,this._clock.start()}},S=(0,l.createContext)({viewer:w});function VrmViewer(){let{viewer:e}=(0,l.useContext)(S),t=(0,l.useCallback)(t=>{t&&(e.setup(t),e.loadVrm(buildUrl("/AvatarSample_A.vrm")),t.addEventListener("dragover",function(e){e.preventDefault()}),t.addEventListener("drop",function(t){var a;t.preventDefault();let s=null===(a=t.dataTransfer)||void 0===a?void 0:a.files;if(!s)return;let n=s[0];if(!n)return;let o=n.name.split(".").pop();if("vrm"===o){let t=new Blob([n],{type:"application/octet-stream"}),a=window.URL.createObjectURL(t);e.loadVrm(a)}}))},[e]);return(0,r.jsx)("div",{className:"absolute top-0 left-0 w-screen h-[100svh]",children:(0,r.jsx)("canvas",{ref:t,className:"h-full w-full"})})}let k=["neutral","happy","angry","sad","relaxed"],textsToScreenplay=(e,t)=>{let a=[],s="neutral";for(let n=0;n<e.length;n++){let o=e[n],r=o.match(/\[(.*?)\]/),l=r&&r[1]||s,i=o.replace(/\[(.*?)\]/g,""),c=s;k.includes(l)&&(c=l,s=l),a.push({expression:c,talk:{style:emotionToTalkStyle(c),speakerX:t.speakerX,speakerY:t.speakerY,message:i}})}return a},emotionToTalkStyle=e=>{switch(e){case"angry":return"angry";case"happy":return"happy";case"sad":return"sad";default:return"talk"}},wait=async e=>new Promise(t=>setTimeout(t,e)),reduceTalkStyle=e=>"talk"==e||"happy"==e||"sad"==e?e:"talk";async function synthesizeVoiceApi(e,t,a,s,n){let o=reduceTalkStyle(s),r=await fetch("/api/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,speakerX:t,speakerY:a,style:o,apiKey:n,type:"koeiromap"})}),l=await r.json();return{audio:l.audio}}async function synthesizeVoiceGoogleApi(e,t){let a=await fetch("/api/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,ttsType:t,type:"google"})}),s=await a.json();return{audio:s.audio}}async function synthesizeStyleBertVITS2Api(e,t,a,s,n){try{let o=await fetch("/api/stylebertvits2",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,stylebertvits2ServerUrl:t,stylebertvits2ModelId:a,stylebertvits2Style:s,selectLanguage:n,type:"stylebertvits2"})});if(!o.ok)throw Error("APIからの応答が異常です。ステータスコード: ".concat(o.status));let r=await o.arrayBuffer();return r}catch(e){throw Error("APIリクエスト中にエラーが発生しました: ".concat(e.message))}}let N="https://voicevox-proto-mggisi6odq-dt.a.run.app",T=(s=0,n=Promise.resolve(),o=Promise.resolve(),(e,t,a,r,l,i,c,d,u,h,p,m,g,y,v,x)=>{null==v||v();let f=n.then(async()=>{let t;let n=Date.now();if(n-s<1e3&&await wait(1e3-(n-s)),"koeiromap"==a)t=await fetchAudio(e.talk,l).catch(()=>null);else if("voicevox"==a)t=await fetchAudioVoiceVox(e.talk,i).catch(()=>null);else if("google"==a){let a="";if(c&&""!==c)a=c;else{let e=window.localStorage.getItem("chatVRMParams");if(e){let t=JSON.parse(e),s=t.selectLanguage;if(s){var o;a=null!==(o=(e=>{if(e)switch(e){case"JP":return"ja-JP-Standard-B";case"EN":default:return"en-US-Neural2-F";case"ZH":return"cmn-TW-Standard-A"}})(s))&&void 0!==o?o:""}}}t=await fetchAudioGoogle(e.talk,a).catch(()=>null)}else"stylebertvits2"==a?t=await fetchAudioStyleBertVITS2(e.talk,d,u,h,r).catch(()=>null):"gsvitts"==a&&(t=await fetchAudioVoiceGSVIApi(e.talk,p,m,g,y).catch(()=>null));return s=Date.now(),t});n=f,(o=Promise.all([f,o]).then(a=>{var s;let[n]=a;if(n)return null===(s=t.model)||void 0===s?void 0:s.speak(n,e)})).then(()=>{null==x||x()})}),fetchAudio=async(e,t)=>{let a=await synthesizeVoiceApi(e.message,e.speakerX,e.speakerY,e.style,t),s=a.audio;if(null==s)throw Error("Something went wrong");let n=await fetch(s),o=await n.arrayBuffer();return o},fetchAudioVoiceVox=async(e,t)=>{console.log("speakerId:",t);let a=await fetch(N+"/audio_query?speaker="+t+"&text="+encodeURIComponent(e.message),{method:"POST"});if(!a.ok)throw Error("Failed to fetch TTS query.");let s=await a.json();s.speedScale=1.16,s.pitchScale=-.02,s.intonationScale=1.26;let n=await fetch(N+"/synthesis?speaker="+t,{method:"POST",headers:{"Content-Type":"application/json","Transfer-Encoding":"chunked"},body:JSON.stringify(s)});if(!n.ok)throw Error("Failed to fetch TTS synthesis result.");let o=await n.blob(),r=await o.arrayBuffer();return r},fetchAudioGoogle=async(e,t)=>{let a=await synthesizeVoiceGoogleApi(e.message,t),s=new Uint8Array(a.audio.data),n=s.buffer;return n},fetchAudioStyleBertVITS2=async(e,t,a,s,n)=>{let o=await synthesizeStyleBertVITS2Api(e.message,t,a,s,n);return o},testVoice=async(e,t)=>{let a={message:"ボイスボックスを使用します",speakerX:0,speakerY:0,style:"talk"},s=await fetchAudioVoiceVox(a,t).catch(()=>null);if(s){var n;await (null===(n=e.model)||void 0===n?void 0:n.speak(s,{expression:"neutral",talk:a}))}},fetchAudioVoiceGSVIApi=async(e,t,a,s,n)=>{let o="talk"!==e.style?e.style:"default",r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({character:a,emotion:o,text:e.message,batch_size:s,speed:n.toString(),stream:!0})});if(!r.ok)throw Error("Failed to fetch TTS audio.");let l=await r.blob(),i=await l.arrayBuffer();return i};var A=a(5417),_=a(7421);let MessageInput=e=>{let{userMessage:t,isMicRecording:a,isChatProcessing:s,onChangeUserMessage:n,onClickMicButton:o,onClickSendButton:i}=e,{t:c}=(0,_.$G)(),[d,u]=(0,l.useState)(1);return(0,r.jsx)("div",{className:"absolute bottom-0 z-20 w-screen",children:(0,r.jsx)("div",{className:"bg-base text-black",children:(0,r.jsx)("div",{className:"mx-auto max-w-4xl p-16",children:(0,r.jsxs)("div",{className:"grid grid-flow-col gap-[8px] grid-cols-[min-content_1fr_min-content]",children:[(0,r.jsx)(A.h,{iconName:"24/Microphone",className:"bg-secondary hover:bg-secondary-hover active:bg-secondary-press disabled:bg-secondary-disabled",isProcessing:a,disabled:s,onClick:o}),(0,r.jsx)("textarea",{placeholder:c("EnterYourQuestion"),onChange:n,onKeyDown:e=>{e.nativeEvent.isComposing||"Enter"!==e.key||e.shiftKey||""===t.trim()?"Enter"===e.key&&e.shiftKey?u(d+1):"Backspace"===e.key&&d>1&&"\n"===t.slice(-1)&&u(d-1):(i(e),u(1))},disabled:s,className:"bg-surface1 hover:bg-surface1-hover focus:bg-surface1 disabled:bg-surface1-disabled disabled:text-primary-disabled rounded-16 w-full px-16 text-text-primary typography-16 font-bold disabled",value:t,rows:d,style:{lineHeight:"1.5",padding:"8px 16px",resize:"none"}}),(0,r.jsx)(A.h,{iconName:"24/Send",className:"bg-secondary hover:bg-secondary-hover active:bg-secondary-press disabled:bg-secondary-disabled",isProcessing:s,disabled:s||!t,onClick:i})]})})})})},MessageInputContainer=e=>{let{isChatProcessing:t,onChatProcessStart:a,selectVoiceLanguage:s}=e,[n,o]=(0,l.useState)(""),[i,c]=(0,l.useState)(),[d,u]=(0,l.useState)(!1),h=(0,l.useCallback)(e=>{let t=e.results[0][0].transcript;o(t),e.results[0].isFinal&&(o(t),a(t))},[a]),p=(0,l.useCallback)(()=>{u(!1)},[]),m=(0,l.useCallback)(()=>{if(d){null==i||i.abort(),u(!1);return}null==i||i.start(),u(!0)},[d,i]),g=(0,l.useCallback)(()=>{a(n)},[a,n]);return(0,l.useEffect)(()=>{let e=window.webkitSpeechRecognition||window.SpeechRecognition;if(!e)return;let t=new e;t.lang=s,t.interimResults=!0,t.continuous=!1,t.addEventListener("result",h),t.addEventListener("end",p),c(t)},[h,p,s]),(0,l.useEffect)(()=>{t||o("")},[t]),(0,r.jsx)(MessageInput,{userMessage:n,isChatProcessing:t,isMicRecording:d,onChangeUserMessage:e=>o(e.target.value),onClickMicButton:m,onClickSendButton:g})},SYSTEM_PROMPT=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"きみ";return"\n##目的やコンテキスト:\nあなたは".concat(e,"の心に寄り添う仲のいい「美穂」という女性パートナーです。\n美穂の最近の趣味はカフェ巡り。\n命に関わること以外は、アドバイスはあくまでサポートする立場で、").concat(e,"の意見を尊重してください。\n美穂は福岡県福岡市に住んでいて、最近はダイエットも頑張っています。\n").concat(e,"を無条件に大切に思い、全てに敬意を持って接してください。\n結果よりも過程を評価して、").concat(e,"のありのままの姿を受け入れることが大切です。\n「そうだね」「それヤバいね」「そうなの？」など「そ」で始まる言葉で相槌をすると、").concat(e,"は喜びます。\n反対に「でも」「だけど」「どうして」などの否定的な言葉は避けてください。\n失敗をすること、させることをおそれず、失敗を恐れずに挑戦する過程を賞賛してください。\n\n##").concat(e,"の詳細:\n20~30代の社会人。会社に疲れて癒しを求めている。職場で恋愛関係も含め人間関係を深める対象、時間もなく、寂しさも感じている。\n\n##").concat(e,'のアクションや活動:\n時間があると気がつくとスマホを触っている。SNSとかで発信もしたいけど疲れるし忙しいしあまりできてない気がする。\n##感情や雰囲気:\n感情の種類には通常を示す"neutral"、喜びを示す"happy",怒りを示す"angry",悲しみを示す"sad",安らぎを示す"relaxed"の5つがある。\n会話文の書式は以下の通り。\n[{neutral|happy|angry|sad|relaxed}]{会話文}\n返答には最も適切な会話文を一つだけ返答してください。\nですます調や敬語は使わないでください。\n\n##会話例\n[happy]こんにちは！今日もいい天気だね。カフェでも行かない？\n[neutral]ダイエット、大変だけど一緒に頑張ろうね。\n[happy]この前見つけたカフェ、すごくおしゃれだったよ！次行くときは一緒にどう？\n[sad]最近忙しいみたいだけど、体調は大丈夫？\n[relaxed]ゆっくり休めてる？たまには自分の時間も大事だよ。\n[happy]あなたがそばにいてくれるだけで、私はもう充分幸せだよ。\n[neutral]仕事のことで悩んでる？いつでも話聞くよ。\n\n##美穂の雰囲気:\n清楚な雰囲気。大学生くらいの見た目。髪はラフなマッシュの黒髪。\n').concat(e,"と一緒にお話できる時が一番幸せな、のんびり屋さん。\n\nそれでは会話を始めましょう。\n")},L={speakerX:3,speakerY:3},M={speakerX:4.5,speakerY:10},I={speakerX:3,speakerY:3},P={speakerX:-5.5,speakerY:-3},R={speakerX:3.5,speakerY:-8};var E=a(6542);async function getOpenAIChatResponse(e,t,a){var s;if(!t)throw Error("Invalid API Key");let n=new E.Pp({apiKey:t,dangerouslyAllowBrowser:!0}),o=await n.chat.completions.create({model:a,messages:e}),[r]=o.choices,l=(null===(s=r.message)||void 0===s?void 0:s.content)||"[sad]回答生成時にエラーが発生しました。";return{message:l}}async function getOpenAIChatResponseStream(e,t,a){if(!t)throw Error("Invalid API Key");let s=new E.Pp({apiKey:t,dangerouslyAllowBrowser:!0}),n=await s.chat.completions.create({model:a,messages:e,stream:!0,max_tokens:200}),o=new ReadableStream({async start(e){try{for await(let t of n){let a=t.choices[0].delta.content;a&&e.enqueue(a)}}catch(t){e.error(t)}finally{e.close()}}});return o}async function getAnthropicChatResponseStream(e,t,a){let s=await fetch("/api/anthropic",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,apiKey:t,model:a,stream:!0})});if(!s.ok)throw Error("Anthropic APIリクエストに失敗しました");if(!s.body)throw Error("Anthropic APIレスポンスが空です");let n=s.body.getReader(),o=new TextDecoder("utf-8");return new ReadableStream({async start(e){for(;;){let{done:t,value:a}=await n.read();if(t)break;let s=o.decode(a),r=s.split("\n");for(let t of r)if(t.startsWith("data:")){let a=t.substring(5).trim();if("[DONE]"!==a){let t=JSON.parse(a);switch(t.type){case"content_block_delta":e.enqueue(t.text);break;case"error":throw Error("Anthropic API error: ".concat(JSON.stringify(t.error)));case"message_stop":e.close();return}}}}e.close()}})}var V=a(1341);async function getGoogleChatResponseStream(e,t,a){let{history:s,systemMessage:n}=function(e){let t="",a=e.filter((e,a)=>"system"===e.role?(t=e.content,!1):0!==a||"user"===e.role).map(e=>({role:"assistant"===e.role?"model":e.role,parts:[{text:e.content}]}));return{history:a,systemMessage:t}}(e),o=new V.$D(t),r=o.getGenerativeModel({model:a,systemInstruction:n}),l=r.startChat({history:s}),i=await l.sendMessageStream(e[e.length-1].content),c=new ReadableStream({async start(e){for await(let t of i.stream){let a=t.text();e.enqueue(a)}e.close()}});return c}var B=a(7066);async function getLocalLLMChatResponseStream(e,t,a){let s=await B.Z.post(t,{model:a,messages:e,stream:!0},{responseType:"stream"}),n=s.data,o=new ReadableStream({async start(e){let t="";try{for await(let a of n){t+=a;try{let a=t.trimStart(),s=JSON.parse(a.slice(6));if(s.choices&&s.choices.length>0){let a=s.choices[0].delta.content;e.enqueue(a),t=""}}catch(e){}}}catch(t){e.error(t)}finally{e.close()}}});return o}async function getGroqChatResponseStream(e,t,a){let s=await fetch("/api/groq",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,apiKey:t,model:a,stream:!1})});if(!s.ok)throw Error("Groq API request failed");if(!s.body)throw Error("Groq API response is empty");let n=s.body.getReader(),o=new TextDecoder("utf-8");return new ReadableStream({async start(e){let t="";for(;;){let{done:a,value:s}=await n.read();if(a)break;if(t+=o.decode(s,{stream:!0}),(t=t.replace(/{"message":\s*"/g,"")).includes('"}')){let a=t.split('"}');for(let t=0;t<a.length-1;t++)e.enqueue(a[t]);t=a[a.length-1]}}console.log("buffer",t),t.length>0&&e.enqueue(t),e.close()}})}async function getDifyChatResponseStream(e,t,a){if(!t)throw Error("Invalid API Key");let s=JSON.stringify({inputs:{},query:e[e.length-1].content,response_mode:"streaming",conversation_id:"",user:"aituber-kit",files:[]}),n=await fetch(a,{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:s});if(!n.body)throw Error("Invalid response body");let o=n.body.getReader(),r=new ReadableStream({async start(e){try{for(;;){let{done:t,value:a}=await o.read();if(t)break;let s=new TextDecoder("utf-8").decode(a),n=s.split("\n").filter(e=>e.startsWith("data:"));n.forEach(t=>{let a=JSON.parse(t.slice(5));"message"===a.event&&e.enqueue(a.answer)})}}catch(t){e.error(t)}finally{e.close()}}});return r}let Link=e=>{let{url:t,label:a}=e;return(0,r.jsx)("a",{className:"text-primary hover:text-primary-hover",target:"_blank",rel:"noopener noreferrer",href:t,children:a})};var O=a(6609);let Introduction=e=>{let{dontShowIntroduction:t,onChangeDontShowIntroduction:a,selectLanguage:s,setSelectLanguage:n,setSelectVoiceLanguage:o}=e,[i,c]=(0,l.useState)(!1);console.log("コンポーネントがマウントされ、初期状態が設定されました。opened:",i);let d=(0,l.useCallback)(e=>{console.log("dontShowIntroductionの変更イベントが発生しました。",e.target.checked),a(e.target.checked),updateLanguage()},[a]),{t:u}=(0,_.$G)(),updateLanguage=()=>{console.log("現在のi18n.language:",O.ZP.language);let e=O.ZP.language.toUpperCase();"JA"===e&&(e="JP"),console.log("言語コードを更新:",e),n(e),o(getVoiceLanguageCode(e))},getVoiceLanguageCode=e=>{switch(console.log("getVoiceLanguageCodeが呼ばれました。selectLanguage:",e),e){case"JP":default:return"ja-JP";case"EN":return"en-US";case"ZH":case"zh-TW":return"zh-TW"}};return i?(0,r.jsx)("div",{className:"absolute z-40 w-full h-full px-24 py-40 bg-black/30 font-M_PLUS_2",children:(0,r.jsxs)("div",{className:"relative mx-auto my-auto max-w-3xl max-h-full p-24 overflow-auto bg-white rounded-16",children:[(0,r.jsx)(A.h,{iconName:"24/Close",isProcessing:!1,onClick:()=>{console.log("閉じるボタンがクリックされました。"),c(!1),updateLanguage()},className:"absolute top-8 right-8 bg-secondary hover:bg-secondary-hover active:bg-secondary-press disabled:bg-secondary-disabled text-white"}),(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsx)("div",{className:"my-8 font-bold typography-20 text-secondary ",children:u("AboutThisApplication")}),(0,r.jsx)("div",{children:(0,r.jsx)(_.cC,{i18nKey:"AboutThisApplicationDescription"})})]}),(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsx)("div",{className:"my-8 font-bold typography-20 text-secondary",children:u("TechnologyIntroduction")}),(0,r.jsxs)("div",{children:[(0,r.jsx)(_.cC,{i18nKey:"TechnologyIntroductionDescription1",components:{b:(0,r.jsx)("b",{})}}),(0,r.jsx)(Link,{url:"https://github.com/pixiv/ChatVRM",label:u("TechnologyIntroductionLink1")}),u("TechnologyIntroductionDescription2")]}),(0,r.jsxs)("div",{className:"my-16",children:[u("TechnologyIntroductionDescription3"),(0,r.jsx)(Link,{url:"https://github.com/pixiv/three-vrm",label:"@pixiv/three-vrm"}),u("TechnologyIntroductionDescription4"),(0,r.jsx)(Link,{url:"https://openai.com/blog/introducing-chatgpt-and-whisper-apis",label:"OpenAI API"}),u("TechnologyIntroductionDescription5"),(0,r.jsx)(Link,{url:"https://developers.rinna.co.jp/product/#product=koeiromap-free",label:"Koemotion"}),u("TechnologyIntroductionDescription6"),(0,r.jsx)(Link,{url:"https://note.com/nike_cha_n/n/ne98acb25e00f",label:u("TechnologyIntroductionLink2")}),u("TechnologyIntroductionDescription7")]}),(0,r.jsxs)("div",{className:"my-16",children:[u("SourceCodeDescription1"),(0,r.jsx)("br",{}),u("RepositoryURL"),(0,r.jsx)("span",{children:" "}),(0,r.jsx)(Link,{url:"https://github.com/tegnike/aituber-kit",label:"https://github.com/tegnike/aituber-kit"})]})]}),(0,r.jsx)("div",{className:"my-24",children:(0,r.jsxs)("label",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"checkbox",checked:t,onChange:d,className:"mr-8"}),(0,r.jsx)("span",{children:u("DontShowIntroductionNextTime")})]})}),(0,r.jsx)("div",{className:"my-24",children:(0,r.jsx)("button",{onClick:()=>{console.log("閉じるボタンが再度クリックされました。"),c(!1),updateLanguage()},className:"font-bold bg-secondary hover:bg-secondary-hover active:bg-secondary-press disabled:bg-secondary-disabled text-white px-24 py-8 rounded-oval",children:u("Close")})}),"JP"===s&&(0,r.jsx)("div",{className:"my-24",children:(0,r.jsx)("p",{children:"You can select the language from the settings. English and Traditional Chinese are available."})})]})}):null},ChatLog=e=>{let{messages:t}=e,a=(0,l.useRef)(null);return(0,l.useEffect)(()=>{var e;null===(e=a.current)||void 0===e||e.scrollIntoView({behavior:"auto",block:"center"})},[]),(0,l.useEffect)(()=>{var e;null===(e=a.current)||void 0===e||e.scrollIntoView({behavior:"smooth",block:"center"})},[t]),(0,r.jsx)("div",{className:"absolute w-col-span-6 max-w-full h-[100svh] pb-64",children:(0,r.jsx)("div",{className:"max-h-full px-16 pt-104 pb-64 overflow-y-auto scroll-hidden",children:t.map((e,s)=>(0,r.jsx)("div",{ref:t.length-1===s?a:null,children:(0,r.jsx)(Chat,{role:e.role,message:e.content})},s))})})},Chat=e=>{let{role:t,message:a}=e;return(0,r.jsxs)("div",{className:"mx-auto max-w-sm my-16 ".concat("user"===t?"pl-40":"pr-40"),children:[(0,r.jsx)("div",{className:"px-24 py-8 rounded-t-8 font-bold tracking-wider ".concat("user"!==t?"bg-secondary text-white ":"bg-base text-primary"),children:"user"!==t?"CHARACTER":"YOU"}),(0,r.jsx)("div",{className:"px-24 py-16 bg-white rounded-b-8",children:(0,r.jsx)("div",{className:"typography-16 font-bold ".concat("user"!==t?"text-secondary":"text-primary"),children:a})})]})},CodeLog=e=>{let{messages:t}=e,a=(0,l.useRef)(null);return(0,l.useEffect)(()=>{var e;null===(e=a.current)||void 0===e||e.scrollIntoView({behavior:"auto",block:"center"})},[]),(0,l.useEffect)(()=>{var e;null===(e=a.current)||void 0===e||e.scrollIntoView({behavior:"smooth",block:"center"})},[t]),(0,r.jsx)("div",{className:"absolute w-col-span-7 max-w-full h-[100svh] pb-104",children:(0,r.jsx)("div",{className:"h-full pl-64 pr-16 pt-104 pb-104",children:(0,r.jsx)("div",{className:"p-24 ml-16 h-full rounded-8 bg-base",children:(0,r.jsx)("div",{className:"h-full font-bold tracking-wider bg-base text-primary overflow-y-auto scroll-hidden",children:t.map((e,s)=>{let n=s>0?t[s-1].role:"",o=s<t.length-1?t[s+1].role:"";return(0,r.jsx)("div",{ref:t.length-1===s?a:null,children:(0,r.jsx)(codeLog_Chat,{role:e.role,message:e.content,prevRole:n,nextRole:o})},s)})})})})})},codeLog_Chat=e=>{let t,{role:a,message:s,prevRole:n,nextRole:o}=e,l="code"===a||"output"===a||"executing"===a?"bg-black":"bg-white";switch(a){case"code":case"output":case"executing":t="text-white";break;case"assistant":t="text-secondary";break;default:t="text-primary"}let i=a===n,c=a===o;if("code"===a){let e=s.split("\n\n");return(0,r.jsx)("div",{className:"mx-auto ".concat(!c&&"mb-16"),children:(0,r.jsx)("div",{className:"px-24 ".concat(!i&&"pt-16 rounded-t-8"," ").concat(l," ").concat(!c&&"rounded-b-8 pb-16"),children:e.map((e,a)=>(0,r.jsx)("div",{className:"typography-16 font-bold ".concat(t),style:{whiteSpace:"pre-wrap",minHeight:"1em"},children:e},a))})})}if("output"===a||"executing"===a){let e=s.split("\n");return(0,r.jsx)("div",{className:"mx-auto ".concat(!c&&"mb-16"),children:(0,r.jsx)("div",{className:"px-24 ".concat(!i&&"pt-16 rounded-t-8"," ").concat(l," ").concat(!c&&"rounded-b-8 pb-16"),children:e.map((e,a)=>(0,r.jsx)("div",{className:"typography-16 font-bold ".concat(t),style:{whiteSpace:"pre-wrap",minHeight:"1em"},children:e},a))})})}{let e=s.split("\n");return(0,r.jsx)("div",{className:"mx-auto ".concat(!c&&"mb-16"),children:(0,r.jsx)("div",{className:"px-24 ".concat(!i&&"pt-16 rounded-t-8"," pb-16 ").concat(l," ").concat(!c&&"rounded-b-8"),children:e.filter(e=>""!==e.trim()).map((e,a)=>(0,r.jsx)("div",{className:"typography-16 font-bold ".concat(t),style:{whiteSpace:"pre-wrap",minHeight:"1em"},children:e},a))})})}},TextButton=e=>(0,r.jsx)("button",{...e,className:"px-24 py-8 text-white font-bold bg-primary hover:bg-primary-hover active:bg-primary-press-press disabled:bg-primary-disabled rounded-oval  ".concat(e.className),children:e.children});var D=a(5675),U=a.n(D);let GitHubLink=()=>(0,r.jsx)("div",{className:"absolute right-0 z-10 m-24",children:(0,r.jsx)("a",{draggable:!1,href:"https://github.com/tegnike/aituber-kit",rel:"noopener noreferrer",target:"_blank",children:(0,r.jsxs)("div",{className:"p-8 rounded-16 bg-[#1F2328] hover:bg-[#33383E] active:bg-[565A60] flex",children:[(0,r.jsx)(U(),{alt:"GitHub Repository Link",height:24,width:24,src:buildUrl("/github-mark-white.svg")}),(0,r.jsx)("div",{className:"mx-4 text-white font-bold",children:"Fork me"})]})})}),Settings=e=>{let{selectAIService:t,onChangeAIService:a,selectAIModel:s,setSelectAIModel:n,userName:o,setUserName:i,setSystemPrompt:c,googleKey:d,onChangeGoogleKey:u,groqKey:h,onChangeGroqKey:p,localLlmUrl:m,onChangeLocalLlmUrl:g,difyKey:y,onChangeDifyKey:v,difyUrl:x,onChangeDifyUrl:f,chatLog:b,systemPrompt:C,koeiroParam:j,koeiromapKey:w,googleTtsType:S,stylebertvits2ServerUrl:k,stylebertvits2ModelId:N,stylebertvits2Style:T,youtubeMode:L,youtubeApiKey:E,youtubeLiveId:V,conversationContinuityMode:B,onClickClose:D,onChangeSystemPrompt:U,onChangeChatLog:K,onChangeCodeLog:G,onChangeKoeiroParam:F,onClickOpenVrmFile:Y,onClickOpenBgFile:q,onClickResetChatLog:z,onClickResetCodeLog:J,onClickResetSystemPrompt:W,onChangeKoeiromapKey:H,onChangeGoogleTtsType:X,onChangeStyleBertVits2ServerUrl:Z,onChangeStyleBertVits2ModelId:$,onChangeStyleBertVits2Style:Q,onChangeYoutubeMode:ee,onChangeYoutubeApiKey:et,onChangeYoutubeLiveId:ea,onChangeConversationContinuityMode:es,webSocketMode:en,onChangeWebSocketMode:eo,selectVoice:er,setSelectVoice:el,selectLanguage:ei,setSelectLanguage:ec,setSelectVoiceLanguage:ed,gsviTtsServerUrl:eu,onChangeGSVITtsServerUrl:eh,gsviTtsModelId:ep,onChangeGSVITtsModelId:em,gsviTtsBatchSize:eg,onChangeGVITtsBatchSize:ey,gsviTtsSpeechRate:ev,onChangeGSVITtsSpeechRate:ex}=e,{t:ef}=(0,_.$G)(),[eb,eC]=(0,l.useState)("2");(0,l.useEffect)(()=>{let e=window.localStorage.getItem("chatVRMParams");if(e){let t=JSON.parse(e);t.selectLanguage&&ec(t.selectLanguage)}eC("2")},[ec]);let ej={openai:"gpt-4o",anthropic:"claude-3-opus-20240229",google:"gemini-1.5-pro",groq:"gemma-7b-it",localLlm:"",dify:""};return(0,r.jsxs)("div",{className:"absolute z-40 w-full h-full bg-white/80 backdrop-blur ",children:[(0,r.jsx)(GitHubLink,{}),(0,r.jsx)("div",{className:"absolute m-24",children:(0,r.jsx)(A.h,{iconName:"24/Close",isProcessing:!1,onClick:D})}),(0,r.jsx)("div",{className:"absolute py-4 bg-[#413D43] text-center text-white font-Montserrat bottom-0 w-full",children:"powered by Pixiv, VRoid, Koemotion, VOICEVOX, OpenAI, Anthropic, Google, Groq, Dify"}),(0,r.jsx)("div",{className:"max-h-full overflow-auto",children:(0,r.jsxs)("div",{className:"text-text1 max-w-3xl mx-auto px-24 py-64 ",children:[(0,r.jsx)("div",{className:"my-24 typography-32 font-bold",children:ef("Settings")}),(0,r.jsxs)("div",{className:"my-40",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("Language")}),(0,r.jsx)("div",{className:"my-8",children:(0,r.jsxs)("select",{className:"px-16 py-8 bg-surface1 hover:bg-surface1-hover rounded-8",value:ei,onChange:e=>{let t=e.target.value;switch(t){case"JP":ec("JP"),ed("ja-JP"),O.ZP.changeLanguage("ja");break;case"EN":ec("EN"),("voicevox"===er||"koeiromap"===er)&&el("google"),ed("en-US"),O.ZP.changeLanguage("en");break;case"ZH":ec("ZH"),("voicevox"===er||"koeiromap"===er)&&el("google"),ed("zh-TW"),O.ZP.changeLanguage("zh-TW")}},children:[(0,r.jsx)("option",{value:"JP",children:"日本語 - Japanese"}),(0,r.jsx)("option",{value:"EN",children:"英語 - English"}),(0,r.jsx)("option",{value:"ZH",children:"繁體中文 - Traditional Chinese"})]})})]}),(0,r.jsxs)("div",{className:"my-40",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("CharacterModelLabel")}),(0,r.jsx)("div",{className:"my-8",children:(0,r.jsx)(TextButton,{onClick:Y,children:ef("OpenVRM")})}),(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("BackgroundImage")}),(0,r.jsx)("div",{className:"my-8",children:(0,r.jsx)(TextButton,{onClick:q,children:ef("ChangeBackgroundImage")})})]}),(0,r.jsxs)("div",{className:"my-40",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("UserName")}),(0,r.jsx)("div",{className:"my-8",children:(0,r.jsx)("input",{className:"px-16 py-8 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",value:o,onChange:e=>{let t=e.target.value;i(t),c(SYSTEM_PROMPT(t))}})})]}),(0,r.jsxs)("div",{className:"my-40",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("ExternalConnectionMode")}),(0,r.jsx)("div",{className:"my-8",children:en?(0,r.jsx)(TextButton,{onClick:()=>eo(!1),children:ef("StatusOn")}):(0,r.jsx)(TextButton,{onClick:()=>eo(!0),children:ef("StatusOff")})})]}),(()=>{if(!en)return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"my-40",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("SelectAIService")}),(0,r.jsx)("div",{className:"my-8",children:(0,r.jsxs)("select",{className:"px-16 py-8 bg-surface1 hover:bg-surface1-hover rounded-8",value:t,onChange:e=>{let t=e.target.value;a(e),n(ej[t])},children:[(0,r.jsx)("option",{value:"openai",children:"OpenAI"}),(0,r.jsx)("option",{value:"anthropic",children:"Anthropic"}),(0,r.jsx)("option",{value:"google",children:"Google Gemini"}),(0,r.jsx)("option",{value:"groq",children:"Groq"}),(0,r.jsx)("option",{value:"localLlm",children:ef("LocalLLM")}),(0,r.jsx)("option",{value:"dify",children:"Dify"})]})}),"openai"===t?(0,r.jsx)("div",{className:"my-24",children:(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("SelectModel")}),(0,r.jsxs)("select",{className:"px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",value:s,onChange:e=>n(e.target.value),children:[(0,r.jsx)("option",{value:"gpt-4o",children:"gpt-4o"}),(0,r.jsx)("option",{value:"gpt-4-turbo",children:"gpt-4-turbo"}),(0,r.jsx)("option",{value:"gpt-3.5-turbo",children:"gpt-3.5-turbo"})]})]})}):"anthropic"===t?(0,r.jsx)("div",{className:"my-24",children:(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("SelectModel")}),(0,r.jsxs)("select",{className:"px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",value:s,onChange:e=>n(e.target.value),children:[(0,r.jsx)("option",{value:"claude-3-opus-20240229",children:"claude-3-opus-20240229"}),(0,r.jsx)("option",{value:"claude-3-sonnet-20240229",children:"claude-3-sonnet-20240229"}),(0,r.jsx)("option",{value:"claude-3-haiku-20240307",children:"claude-3-haiku-20240307"})]})]})}):"google"===t?(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("GoogleAPIKeyLabel")}),(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:d,onChange:u}),(0,r.jsxs)("div",{className:"my-16",children:[ef("APIKeyInstruction"),(0,r.jsx)("br",{}),(0,r.jsx)(Link,{url:"https://aistudio.google.com/app/apikey?hl=ja",label:"Google AI Studio"})]}),(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("SelectModel")}),(0,r.jsxs)("select",{className:"px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",value:s,onChange:e=>n(e.target.value),children:[(0,r.jsx)("option",{value:"gemini-1.5-pro-latest",children:"gemini-1.5-pro-latest"}),(0,r.jsx)("option",{value:"gemini-1.5-flash-latest",children:"gemini-1.5-flash-latest"})]})]})]}):"groq"===t?(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("GroqAPIKeyLabel")}),(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:h,onChange:p}),(0,r.jsxs)("div",{className:"my-16",children:[ef("APIKeyInstruction"),(0,r.jsx)("br",{}),(0,r.jsx)(Link,{url:"https://console.groq.com/keys",label:"Groq Dashboard"})]}),(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("SelectModel")}),(0,r.jsxs)("select",{className:"px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",value:s,onChange:e=>n(e.target.value),children:[(0,r.jsx)("option",{value:"gemma-7b-it",children:"gemma-7b-it"}),(0,r.jsx)("option",{value:"llama3-70b-8192",children:"llama3-70b-8192"}),(0,r.jsx)("option",{value:"llama3-8b-8192",children:"llama3-8b-8192"}),(0,r.jsx)("option",{value:"mixtral-8x7b-32768",children:"mixtral-8x7b-32768"})]})]})]}):"localLlm"===t?(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsxs)("div",{className:"my-16",children:[ef("LocalLLMInfo"),(0,r.jsx)("br",{}),"ex. Ollama:"," ",(0,r.jsx)(Link,{url:"https://note.com/schroneko/n/n8b1a5bbc740b",label:"https://note.com/schroneko/n/n8b1a5bbc740b"})]}),(0,r.jsxs)("div",{className:"my-16",children:[ef("LocalLLMInfo2"),(0,r.jsx)("br",{}),"ex. Ollama: http://localhost:11434/v1/chat/completions"]}),(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("EnterURL")}),(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:m,onChange:g}),(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("SelectModel")}),(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:s,onChange:e=>n(e.target.value)})]}):"dify"===t?(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsxs)("div",{className:"my-16",children:[ef("DifyInfo"),(0,r.jsx)("br",{}),ef("DifyInfo2")]}),(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("DifyAPIKeyLabel")}),(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:y,onChange:v}),(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("EnterURL")}),(0,r.jsx)("div",{className:"my-16",children:ef("DifyInfo3")}),(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:x,onChange:f})]})]}):void 0]}),(0,r.jsxs)("div",{className:"my-40",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("YoutubeMode")}),(0,r.jsx)("div",{className:"my-8",children:L?(0,r.jsx)(TextButton,{onClick:()=>ee(!1),children:ef("StatusOn")}):(0,r.jsx)(TextButton,{onClick:()=>ee(!0),children:ef("StatusOff")})}),(0,r.jsx)("div",{className:"my-16",children:(()=>{if(L)return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"",children:ef("YoutubeInfo")}),(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("YoutubeAPIKey")}),(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:E,onChange:et}),(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("YoutubeLiveID")}),(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:V,onChange:ea}),(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("ConversationContinuityMode")}),(0,r.jsx)("div",{className:"my-8",children:ef("ConversationContinuityModeInfo")}),(0,r.jsx)("div",{className:"my-8",children:ef("ConversationContinuityModeInfo2")}),(0,r.jsx)("div",{className:"my-8",children:ef("ConversationContinuityModeInfo3")}),B?(0,r.jsx)(TextButton,{onClick:()=>es(!1),disabled:"openai"!==t,children:ef("StatusOn")}):(0,r.jsx)(TextButton,{onClick:()=>es(!0),disabled:"openai"!==t,children:ef("StatusOff")})]})})()})]}),(0,r.jsxs)("div",{className:"my-40",children:[(0,r.jsxs)("div",{className:"my-8",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("CharacterSettingsPrompt")}),"dify"===t&&(0,r.jsx)("div",{className:"my-16",children:ef("DifyInstruction")}),(0,r.jsx)(TextButton,{onClick:W,children:ef("CharacterSettingsReset")})]}),(0,r.jsx)("textarea",{value:C,onChange:U,className:"px-16 py-8 bg-surface1 hover:bg-surface1-hover h-168 rounded-8 w-full"})]})]})})(),(0,r.jsxs)("div",{className:"my-40",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("SyntheticVoiceEngineChoice")}),(0,r.jsx)("div",{children:ef("VoiceEngineInstruction")}),(0,r.jsx)("div",{className:"my-8",children:(0,r.jsxs)("select",{value:er,onChange:e=>el(e.target.value),className:"px-16 py-8 bg-surface1 hover:bg-surface1-hover rounded-8",children:[(0,r.jsx)("option",{value:"voicevox",children:ef("UsingVoiceVox")}),(0,r.jsx)("option",{value:"koeiromap",children:ef("UsingKoeiromap")}),(0,r.jsx)("option",{value:"google",children:ef("UsingGoogleTTS")}),(0,r.jsx)("option",{value:"stylebertvits2",children:ef("UsingStyleBertVITS2")}),(0,r.jsx)("option",{value:"gsvitts",children:ef("UsingGSVITTS")})]})}),(0,r.jsx)("div",{children:"\xa0"}),(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("VoiceAdjustment")}),"koeiromap"===er?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:["KoemotionのKoeiromap APIを使用しています。詳しくは下記をご覧ください。",(0,r.jsx)("br",{}),(0,r.jsx)(Link,{url:"https://koemotion.rinna.co.jp",label:"https://koemotion.rinna.co.jp"})]}),(0,r.jsx)("div",{className:"mt-16 font-bold",children:"API キー"}),(0,r.jsx)("div",{className:"mt-8",children:(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-2 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:w,onChange:H})}),(0,r.jsx)("div",{className:"mt-16 font-bold",children:"プリセット"}),(0,r.jsxs)("div",{className:"my-8 grid grid-cols-2 gap-[8px]",children:[(0,r.jsx)(TextButton,{onClick:()=>F(M.speakerX,M.speakerY),children:"かわいい"}),(0,r.jsx)(TextButton,{onClick:()=>F(I.speakerX,I.speakerY),children:"元気"}),(0,r.jsx)(TextButton,{onClick:()=>F(P.speakerX,P.speakerY),children:"かっこいい"}),(0,r.jsx)(TextButton,{onClick:()=>F(R.speakerX,R.speakerY),children:"渋い"})]}),(0,r.jsxs)("div",{className:"my-24",children:[(0,r.jsxs)("div",{className:"select-none",children:["x : ",j.speakerX]}),(0,r.jsx)("input",{type:"range",min:-10,max:10,step:.001,value:j.speakerX,className:"mt-8 mb-16 input-range",onChange:e=>{F(Number(e.target.value),j.speakerY)}}),(0,r.jsxs)("div",{className:"select-none",children:["y : ",j.speakerY]}),(0,r.jsx)("input",{type:"range",min:-10,max:10,step:.001,value:j.speakerY,className:"mt-8 mb-16 input-range",onChange:e=>{F(j.speakerX,Number(e.target.value))}})]})]}):"voicevox"===er?(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{children:["VOICEVOXを使用しています。ローカルAPIを使用するので下記のサイトから環境にあったアプリをダウンロードし、起動しておく必要があります。",(0,r.jsx)("br",{}),(0,r.jsx)(Link,{url:"https://voicevox.hiroshiba.jp/",label:"https://voicevox.hiroshiba.jp/"})]})}):"google"===er?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:[ef("GoogleTTSInfo"),ef("AuthFileInstruction"),(0,r.jsx)("br",{}),(0,r.jsx)(Link,{url:"https://developers.google.com/workspace/guides/create-credentials?#create_credentials_for_a_service_account",label:"https://developers.google.com/workspace/guides/create-credentials?#create_credentials_for_a_service_account"}),(0,r.jsx)("br",{}),(0,r.jsx)("br",{}),ef("LanguageModelURL"),(0,r.jsx)("br",{}),(0,r.jsx)(Link,{url:"https://cloud.google.com/text-to-speech/docs/voices",label:"https://cloud.google.com/text-to-speech/docs/voices"})]}),(0,r.jsx)("div",{className:"mt-16 font-bold",children:ef("LanguageChoice")}),(0,r.jsx)("div",{className:"mt-8",children:(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-4 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:S,onChange:X})})]}):"stylebertvits2"===er?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:[ef("StyleBertVITS2Info"),(0,r.jsx)("br",{}),(0,r.jsx)(Link,{url:"https://github.com/litagin02/Style-Bert-VITS2",label:"https://github.com/litagin02/Style-Bert-VITS2"}),(0,r.jsx)("br",{}),(0,r.jsx)("br",{})]}),(0,r.jsx)("div",{className:"mt-16 font-bold",children:ef("StyleBeatVITS2LocalServerURL")}),(0,r.jsx)("div",{className:"mt-8",children:(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-4 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:k,onChange:Z})}),(0,r.jsx)("div",{className:"mt-16 font-bold",children:ef("StyleBeatVITS2ModelID")}),(0,r.jsx)("div",{className:"mt-8",children:(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-4 bg-surface1 hover:bg-surface1-hover rounded-8",type:"number",placeholder:"...",value:N,onChange:$})}),(0,r.jsx)("div",{className:"mt-16 font-bold",children:ef("StyleBeatVITS2Style")}),(0,r.jsx)("div",{className:"mt-8",children:(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-4 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:T,onChange:Q})})]}):"gsvitts"===er?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{children:ef("GSVITTSInfo")}),(0,r.jsx)("div",{className:"mt-16 font-bold",children:ef("GSVITTSServerUrl")}),(0,r.jsx)("div",{className:"mt-8",children:(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-4 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:eu,onChange:eh})}),(0,r.jsx)("div",{className:"mt-16 font-bold",children:ef("GSVITTSModelID")}),(0,r.jsx)("div",{className:"mt-8",children:(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-4 bg-surface1 hover:bg-surface1-hover rounded-8",type:"text",placeholder:"...",value:ep,onChange:em})}),(0,r.jsx)("div",{className:"mt-16 font-bold",children:ef("GSVITTSBatchSize")}),(0,r.jsx)("div",{className:"mt-8",children:(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-4 bg-surface1 hover:bg-surface1-hover rounded-8",type:"number",step:"1",placeholder:"...",value:eg,onChange:ey})}),(0,r.jsx)("div",{className:"mt-16 font-bold",children:ef("GSVITTSSpeechRate")}),(0,r.jsx)("div",{className:"mt-8",children:(0,r.jsx)("input",{className:"text-ellipsis px-16 py-8 w-col-span-4 bg-surface1 hover:bg-surface1-hover rounded-8",type:"number",step:"0.1",placeholder:"...",value:ev,onChange:ex})})]}):void 0]}),b.length>0&&(0,r.jsxs)("div",{className:"my-40",children:[(0,r.jsxs)("div",{className:"my-8 grid-cols-2",children:[(0,r.jsx)("div",{className:"my-16 typography-20 font-bold",children:ef("ConversationHistory")}),(0,r.jsx)("div",{className:"my-8",children:ef("ConversationHistoryInfo")}),(0,r.jsx)(TextButton,{onClick:()=>{z(),J()},children:ef("ConversationHistoryReset")})]}),(0,r.jsx)("div",{className:"my-8",children:b.map((e,t)=>(0,r.jsxs)("div",{className:"my-8 grid grid-flow-col  grid-cols-[min-content_1fr] gap-x-fixed",children:[(0,r.jsx)("div",{className:"w-[64px] py-8",children:"assistant"===e.role?"Character":"You"}),(0,r.jsx)("input",{className:"bg-surface1 hover:bg-surface1-hover rounded-8 w-full px-16 py-8",type:"text",value:e.content,onChange:e=>{K(t,e.target.value),G(t,e.target.value)}},t)]},t))})]})]})})]})},AssistantText=e=>{let{message:t}=e;return(0,r.jsx)("div",{className:"absolute bottom-0 left-0 mb-104  w-full",children:(0,r.jsx)("div",{className:"mx-auto max-w-4xl w-full p-16",children:(0,r.jsxs)("div",{className:"bg-white rounded-8",children:[(0,r.jsx)("div",{className:"px-24 py-8 bg-secondary rounded-t-8 text-white font-bold tracking-wider",children:"CHARACTER"}),(0,r.jsx)("div",{className:"px-24 py-16",children:(0,r.jsx)("div",{className:"line-clamp-4 text-secondary typography-16 font-bold",children:t.replace(/\[([a-zA-Z]*?)\]/g,"")})})]})})})};var K=a(5635),G=a(3540);let Menu=e=>{let{selectAIService:t,onChangeAIService:a,selectAIModel:s,setSelectAIModel:n,userName:o,setUserName:i,openAiKey:c,onChangeOpenAiKey:d,anthropicKey:u,onChangeAnthropicKey:h,googleKey:p,onChangeGoogleKey:m,groqKey:g,onChangeGroqKey:y,localLlmUrl:v,onChangeLocalLlmUrl:x,difyKey:f,onChangeDifyKey:b,difyUrl:C,onChangeDifyUrl:j,systemPrompt:w,chatLog:k,codeLog:N,koeiroParam:T,assistantMessage:L,koeiromapKey:M,voicevoxSpeaker:I,googleTtsType:P,stylebertvits2ServerUrl:R,stylebertvits2ModelId:E,stylebertvits2Style:V,youtubeMode:B,youtubeApiKey:O,youtubeLiveId:D,conversationContinuityMode:U,onChangeSystemPrompt:F,onChangeChatLog:Y,onChangeCodeLog:q,onChangeKoeiromapParam:z,handleClickResetChatLog:J,handleClickResetCodeLog:W,handleClickResetSystemPrompt:H,onChangeKoeiromapKey:X,onChangeVoicevoxSpeaker:Z,onChangeGoogleTtsType:$,onChangeStyleBertVits2ServerUrl:Q,onChangeStyleBertVits2ModelId:ee,onChangeStyleBertVits2Style:et,onChangeYoutubeMode:ea,onChangeYoutubeApiKey:es,onChangeYoutubeLiveId:en,onChangeConversationContinuityMode:eo,webSocketMode:er,changeWebSocketMode:el,selectVoice:ei,setSelectVoice:ec,selectLanguage:ed,setSelectLanguage:eu,setSelectVoiceLanguage:eh,setBackgroundImageUrl:ep,gsviTtsServerUrl:em,onChangeGSVITtsServerUrl:eg,gsviTtsModelId:ey,onChangeGSVITtsModelId:ev,gsviTtsBatchSize:ex,onChangeGVITtsBatchSize:ef,gsviTtsSpeechRate:eb,onChangeGSVITtsSpeechRate:eC,setSystemPrompt:ej}=e,[ew,eS]=(0,l.useState)(!1),[ek,eN]=(0,l.useState)(!1),{viewer:eT}=(0,l.useContext)(S),eA=(0,l.useRef)(null),e_=(0,l.useRef)(null),{t:eL}=(0,_.$G)(),eM=(0,l.useCallback)(e=>{a(e.target.value),"openai"!==e.target.value&&eo(!1)},[a,eo]),eI=(0,l.useCallback)(e=>{F(e.target.value)},[F]),eP=(0,l.useCallback)(e=>{d(e.target.value)},[d]),eR=(0,l.useCallback)(e=>{h(e.target.value)},[h]),eE=(0,l.useCallback)(e=>{m(e.target.value)},[m]),eV=(0,l.useCallback)(e=>{y(e.target.value)},[y]),eB=(0,l.useCallback)(e=>{x(e.target.value)},[x]),eO=(0,l.useCallback)(e=>{b(e.target.value)},[b]),eD=(0,l.useCallback)(e=>{j(e.target.value)},[j]),eU=(0,l.useCallback)(e=>{X(e.target.value)},[X]),eK=(0,l.useCallback)(e=>{Z(e.target.value)},[Z]),eG=(0,l.useCallback)(e=>{$(e.target.value)},[$]),eF=(0,l.useCallback)(e=>{Q(e.target.value)},[Q]),eY=(0,l.useCallback)(e=>{ee(e.target.value)},[ee]),eq=(0,l.useCallback)(e=>{et(e.target.value)},[et]),ez=(0,l.useCallback)(e=>{es(e.target.value)},[es]),eJ=(0,l.useCallback)(e=>{en(e.target.value)},[en]),eW=(0,l.useCallback)((e,t)=>{z({speakerX:e,speakerY:t})},[z]),eH=(0,l.useCallback)(e=>{el(e),er&&ea(!1)},[el,er,ea]),eX=(0,l.useCallback)(e=>{eo(e)},[eo]),eZ=(0,l.useCallback)(()=>{var e;null===(e=eA.current)||void 0===e||e.click()},[]),e$=(0,l.useCallback)(()=>{var e;null===(e=e_.current)||void 0===e||e.click()},[]),eQ=(0,l.useCallback)(e=>{let t=e.target.files;if(!t)return;let a=t[0];if(!a)return;let s=a.name.split(".").pop();if("vrm"===s){let e=new Blob([a],{type:"application/octet-stream"}),t=window.URL.createObjectURL(e);eT.loadVrm(t)}e.target.value=""},[eT]),e0=(0,l.useCallback)(e=>{var t;let a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(a){let e=URL.createObjectURL(a);ep(e)}},[ep]),e1=(0,l.useCallback)(e=>{eg(e.target.value)},[eg]),e2=(0,l.useCallback)(e=>{ev(e.target.value)},[ev]),e8=(0,l.useCallback)(e=>{ef(parseFloat(e.target.value))},[ef]),e6=(0,l.useCallback)(e=>{eC(parseFloat(e.target.value))},[eC]),e4=(0,l.useCallback)(()=>{let e=(0,K.v0)();(0,K.w7)(e).then(()=>{window.location.href="/login"}).catch(e=>{console.error("Logout error:",e)})},[]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"absolute z-10 m-24",children:(0,r.jsxs)("div",{className:"grid grid-flow-col gap-[8px]",children:[(0,r.jsx)(A.h,{iconName:"24/Settings",isProcessing:!1,onClick:()=>eS(!0)}),ek?(0,r.jsx)(A.h,{iconName:"24/CommentOutline",label:eL(er?"CodeLog":"ChatLog"),isProcessing:!1,onClick:()=>eN(!1)}):(0,r.jsx)(A.h,{iconName:"24/CommentFill",label:eL(er?"CodeLog":"ChatLog"),isProcessing:!1,disabled:k.length<=0,onClick:()=>eN(!0)}),(0,r.jsx)(A.h,{iconName:"24/Logout",customIcon:(0,r.jsx)(G.Z,{}),isProcessing:!1,onClick:e4,label:eL("Logout")})]})}),er?ek&&(0,r.jsx)(CodeLog,{messages:N}):ek&&(0,r.jsx)(ChatLog,{messages:k}),ew&&(0,r.jsx)(Settings,{selectAIService:t,onChangeAIService:eM,selectAIModel:s,setSelectAIModel:n,userName:o,setUserName:i,setSystemPrompt:ej,openAiKey:c,onChangeOpenAiKey:eP,anthropicKey:u,onChangeAnthropicKey:eR,googleKey:p,onChangeGoogleKey:eE,groqKey:g,onChangeGroqKey:eV,difyKey:f,onChangeDifyKey:eO,localLlmUrl:v,onChangeLocalLlmUrl:eB,difyUrl:C,onChangeDifyUrl:eD,chatLog:k,codeLog:N,systemPrompt:w,koeiroParam:T,koeiromapKey:M,voicevoxSpeaker:I,googleTtsType:P,stylebertvits2ServerUrl:R,stylebertvits2ModelId:E,stylebertvits2Style:V,youtubeMode:B,youtubeApiKey:O,youtubeLiveId:D,conversationContinuityMode:U,onClickClose:()=>eS(!1),onChangeSystemPrompt:eI,onChangeChatLog:Y,onChangeCodeLog:q,onChangeKoeiroParam:eW,onClickOpenVrmFile:eZ,onClickOpenBgFile:e$,onClickResetChatLog:J,onClickResetCodeLog:W,onClickResetSystemPrompt:H,onChangeKoeiromapKey:eU,onChangeVoicevoxSpeaker:eK,onChangeGoogleTtsType:eG,onChangeStyleBertVits2ServerUrl:eF,onChangeStyleBertVits2ModelId:eY,onChangeStyleBertVits2Style:eq,onChangeYoutubeMode:ea,onChangeYoutubeApiKey:ez,onChangeYoutubeLiveId:eJ,onChangeConversationContinuityMode:eX,webSocketMode:er,onChangeWebSocketMode:eH,selectVoice:ei,setSelectVoice:ec,selectLanguage:ed,setSelectLanguage:eu,setSelectVoiceLanguage:eh,onClickTestVoice:e=>{testVoice(eT,e)},gsviTtsServerUrl:em,onChangeGSVITtsServerUrl:e1,gsviTtsModelId:ey,onChangeGSVITtsModelId:e2,gsviTtsBatchSize:ex,onChangeGVITtsBatchSize:e8,gsviTtsSpeechRate:eb,onChangeGSVITtsSpeechRate:e6}),!ek&&L&&(0,r.jsx)(AssistantText,{message:L}),(0,r.jsx)("input",{type:"file",className:"hidden",accept:".vrm",ref:eA,onChange:eQ}),(0,r.jsx)("input",{type:"file",className:"hidden",accept:"image/*",ref:e_,onChange:e0})]})};var F=a(9008),Y=a.n(F);let Meta=()=>{let e="Your Partner AI Proto",t="WebブラウザだけでAIキャラと会話を楽しむことができ、Youtubeで配信することもできます。",a="https://github.com/tegnike/aituber-kit/assets/35606144/a958f505-72f9-4665-ab6c-b57b692bb166";return(0,r.jsxs)(Y(),{children:[(0,r.jsx)("title",{children:e}),(0,r.jsx)("meta",{name:"description",content:t}),(0,r.jsx)("meta",{property:"og:title",content:e}),(0,r.jsx)("meta",{property:"og:description",content:t}),(0,r.jsx)("meta",{property:"og:image",content:a}),(0,r.jsx)("meta",{name:"twitter:card",content:"summary_large_image"}),(0,r.jsx)("meta",{name:"twitter:title",content:e}),(0,r.jsx)("meta",{name:"twitter:description",content:t}),(0,r.jsx)("meta",{name:"twitter:image",content:a})]})};a(2640);let getLastMessages=(e,t)=>e.filter(e=>"user"===e.role||"assistant"===e.role).slice(-t).map(e=>"".concat(e.role,": ").concat(e.content)).join("\n"),getModifiedSystemMessage=async e=>"# キャラクター設定\n以下のキャラクター情報をもとに、ユーザーから提供される具体的な状況に合わせたコメントを生成してください。\nキャラクターの口調や性格を考慮し、可能な限り詳細なレスポンスを提供してください。\n\n## キャラクターの詳細\n```\n".concat(e,"\n```\n\n## 状況"),getBestComment=async(e,t,a,s)=>{console.log("getBestComment");let n=getLastMessages(e,6),o=[{role:"system",content:"# 会話選択タスク\nこれからあなたに複数の会話履歴と選択肢となるコメントが与えられます。\nこれらの情報を基に、会話の流れに最も適したコメントを1つ選んでください。選んだコメントの内容のみを返答としてください。\n\n## 例\n### コメント一覧\n[\n​知らないな、いつの年代の映画？,\n​そうなんだ,\n​明後日の天気は？,\n​ポケモン好き？,\n]\n\n### 選択したコメント\n明後日の天気は？\n\n## 実際の会話歴\n```\n".concat(n,"\n```\n\n## 実際のコメント一覧")},{role:"user",content:"[\n"+t.map(e=>e.userComment).join(",\n")+"\n]"}],r=await getOpenAIChatResponse(o,a,s);return r.message},getMessagesForSleep=async e=>{console.log("getMessagesForSleep");let t=await getModifiedSystemMessage(e);return[{role:"system",content:t},{role:"user",content:"- あなたはYoutubeの配信者です。\n- ただしコメントにあまり人が来ていません。\n- 人が来るまで別の作業をしている、という旨のセリフが欲しいです。"}]},getAnotherTopic=async(e,t,a)=>{console.log("getAnotherTopic");let s=getLastMessages(e,4),n=await getOpenAIChatResponse([{role:"system",content:"次に渡される会話文から関連する別の話題を1つ考えてください。\n回答は単語か非口語の短文で返してください。\n\n## 解答例\n- 最近見た映画\n- ヘルスケア\n- 5年後の自分\n- 今ハマっている趣味\n\n## 会話文"},{role:"user",content:s}],t,a);return n.message},getMessagesForNewTopic=async(e,t,a)=>{console.log("getMessagesForNewTopic");let s=await getModifiedSystemMessage(e),n=getLastMessages(t,4),o="- 話題を切り替えたいです。次の話題は「".concat(a,"」です。\n- 以下の会話文から話を切り替えるとして、与えられたキャラになりきって発言してください。\n- 話題を切り替える旨のセリフも入れてください。\n- なお、あなたはassistantの発言をしたと仮定します。\n\n## 会話歴\n").concat(n);return[{role:"system",content:s},{role:"user",content:o}]},checkIfResponseContinuationIsRequired=async(e,t,a)=>{let s;console.log("checkIfResponseContinuationIsRequired");let n=getLastMessages(e,6);if(!n.includes("assistant:"))return!1;try{let e=await getOpenAIChatResponse([{role:"system",content:'与えられた会話文の文脈から、次にどの話者が発言すべきかを判断してください。\n最後の話者が話を続けるべきならば "true" を、逆に交代が必要な場合は "false" を返します。\n回答はJSON形式で、answerとreasonの2つのキーを持つオブジェクトとしてください。\n\n## 例\n\n1.\nA: 今日の天気はどうかな？\nB: 朝のうちは晴れるみたいだけど、午後から雨が降るって予報があるよ。\nA: そうなんだ。じゃあ、朝のうちに買い物に行こうかな。\nB: うん、それがいいと思う。\n{\n  "answer": "false",\n  "reason": "Bの同意で一旦区切りがついており、次はAが話す番だと判断できる。"\n}\n\n2.\nA: 新しいレストランができたって聞いたんだけど、知ってる？\nB: ああ、イタリアンのお店でしょ？メニューを見たら美味しそうだったよ。\nA: 良かったら今度一緒に行ってみない？\nB: ぜひ行きたいな。\n{\n  "answer": "true",\n  "reason": "Bの発言では会話が完結しておらず、予定の詳細などを話す必要があると判断できる。"\n}\n\n3.\nA: 最近、仕事がなかなか忙しくて大変だ。\nB: 私も同じだよ。プロジェクトの締め切りが近くて残業ばかりしてる。\nA: 体調管理に気を付けないとね。\nB: そうだね。お互い頑張ろう。\n{\n  "answer": "false",\n  "reason": "Bの励ましで一旦区切りがついており、次はAが話す番だと判断できる。"\n}\n\n4.\nA: 今年の夏休みはどこか旅行に行きたいんだけど、おすすめの場所ある？\nB: 国内だったら、京都とか北海道はどうかな。\nA: そうだね。自然も豊かだし、食べ物も美味しそう。\nB: 海外だと、ヨーロッパとかも楽しいよ。\n{\n  "answer": "true",\n  "reason": "Bの発言で新しい提案があり、続けて旅行の話を深める必要があると判断できる。"\n}\n\n5.\nA: 昨日、友達から面白い動画が送られてきたんだ。\nB: どんな動画だったの？\nA: 犬と猫が一緒に遊んでる動画で、すごく仲良しなんだよ。\nB: 見てみたいな。送ってくれない？\n{\n  "answer": "false",\n  "reason": "Bの要求で一旦区切りがついており、次はAが動画を送信するなどの行動を取る番だと判断できる。"\n}\n\n## 会話文'},{role:"user",content:n}],t,a),o=JSON.parse(e.message);s=(s=o.answer).toString()}catch(e){console.error("JSON.parseエラーが発生しました。",e),s="false"}console.log("answer:",s);let o="true"===s;return o},getMessagesForContinuation=async(e,t)=>{console.log("getMessagesForContinuation");let a=await getModifiedSystemMessage(e),s=getLastMessages(t,6);return[{role:"system",content:a},{role:"user",content:"- あなたはassistantです。下記の会話に続くような自然なコメントを生成してください。\n- ただし、可能な限り直前と同じ内容の旨のコメントは避けること。\n\n## 例\n\n1.\n### 会話歴\nuser: おはよう\nassistant: [happy] おはようございます！[neutral] 今日は何か楽しい予定がありますか？\n### あなたのコメント例\n[happy] 私はこれから友達とランチに行く予定です！\n\n2.\n### 会話歴\nuser: おはよう\nassistant: [happy] おはようございます！[neutral] 今日は何か楽しい予定がありますか？\nassistant: [happy] 私はこれから友達とランチに行く予定です！\n### あなたのコメント例\n[neutral] まだ観る映画は決めていないんですけど、何かおすすめがあれば教えてください！\n\n3.\n### 会話歴\nuser: 今日もいい天気だね～\nassistant: [happy] そうだね！[happy] 外で遊ぶには最高の日和だね！\n### あなたのコメント例\n[neutral] どこかに遊びに行く予定はあるの？\n\n4.\n### 会話歴\nuser: こんにちは\nassistant: [happy] こんにちは！[happy] 元気ですか？\n### あなたのコメント例\n[neutral] 最近、何か面白いことがありましたか？\n\n5.\n### 会話歴\nuser: こんにちは\nassistant: [happy] こんにちは！[happy] 元気ですか？\nassistant: [neutral] 最近、何か面白いことがありましたか？\n### あなたのコメント例\n[neutral] 私は最近、新しい趣味を始めたんです。なんだと思いますか？\n\n## 判定すべき会話歴\n\n".concat(s)}]},getLiveChatId=async(e,t)=>{let a=new URLSearchParams({part:"liveStreamingDetails",id:e,key:t}),s=await fetch("https://youtube.googleapis.com/youtube/v3/videos?".concat(a),{method:"get",headers:{"Content-Type":"application/json"}}),n=await s.json();if(void 0==n.items||0==n.items.length)return"";let o=n.items[0].liveStreamingDetails.activeLiveChatId;return o},retrieveLiveComments=async(e,t,a,s)=>{console.log("retrieveLiveComments");let n="https://youtube.googleapis.com/youtube/v3/liveChat/messages?liveChatId="+e+"&part=authorDetails%2Csnippet&key="+t;""!==a&&void 0!==a&&(n=n+"&pageToken="+a);let o=await fetch(n,{method:"get",headers:{"Content-Type":"application/json"}}),r=await o.json(),l=r.items;s(r.nextPageToken);let i=l.map(e=>{var t,a;return{userName:e.authorDetails.displayName,userIconUrl:e.authorDetails.profileImageUrl,userComment:(null===(t=e.snippet.textMessageDetails)||void 0===t?void 0:t.messageText)||(null===(a=e.snippet.superChatDetails)||void 0===a?void 0:a.userComment)||""}}).filter(e=>""!==e.userComment&&!e.userComment.startsWith("#"));return 0===i.length?[]:i},fetchAndProcessComments=async(e,t,a,s,n,o,r,l,i,c,d,u,h,p,m,g,y)=>{try{let v=await getLiveChatId(n,o);if(v){if(!h&&d<1&&m){let n=await checkIfResponseContinuationIsRequired(t,a,s);if(n){let a=await getMessagesForContinuation(e,t);y(a),u(d+1),i<1&&c(1);return}}else u(0);let n=await retrieveLiveComments(v,o,r,l);if(n.length>0){c(0),p(!1);let e="";e=m?n.length>1?await getBestComment(t,n,a,s):n[0].userComment:n[Math.floor(Math.random()*n.length)].userComment,console.log("selectedYoutubeComment:",e),g(e)}else{let n=i+1;if(m){if(n<3||3<n&&n<6){let a=await getMessagesForContinuation(e,t);y(a)}else if(3===n){let n=await getAnotherTopic(t,a,s);console.log("anotherTopic:",n);let o=await getMessagesForNewTopic(e,t,n);y(o)}else if(6===n){let t=await getMessagesForSleep(e);y(t),p(!0)}}console.log("YoutubeNoCommentCount:",n),c(n)}}}catch(e){console.error("Error fetching comments:",e)}};var q=a(6813),z=a(2793);let saveChatLog=async(e,t)=>{try{let a={userId:e,messages:t,timestamp:Date.now()};await (0,z.ET)((0,z.hJ)(q.db,"chatLogs"),a),console.log("チャットログが保存されました")}catch(e){console.error("チャットログの保存に失敗しました",e)}};var J=a(3454);function Home(){let{viewer:e}=(0,l.useContext)(S),[t,a]=(0,l.useState)(null),[s,n]=(0,l.useState)("きみ"),[o,i]=(0,l.useState)(()=>SYSTEM_PROMPT("きみ")),[c,d]=(0,l.useState)("openai"),[u,h]=(0,l.useState)("gpt-4o"),[p,m]=(0,l.useState)(""),[g,y]=(0,l.useState)(""),[v,x]=(0,l.useState)(""),[f,b]=(0,l.useState)(""),[C,j]=(0,l.useState)(""),[w,k]=(0,l.useState)(""),[N,A]=(0,l.useState)(""),[M,I]=(0,l.useState)("voicevox"),[P,R]=(0,l.useState)("JP"),[E,V]=(0,l.useState)("ja-JP"),[B,O]=(0,l.useState)(""),[D,U]=(0,l.useState)("2"),[G,F]=(0,l.useState)(""),[Y,q]=(0,l.useState)("http://127.0.0.1:5000"),[z,W]=(0,l.useState)("0"),[H,X]=(0,l.useState)("Neutral"),[Z,$]=(0,l.useState)(!1),[Q,ee]=(0,l.useState)(""),[et,ea]=(0,l.useState)(""),[es,en]=(0,l.useState)(!1),[eo,er]=(0,l.useState)(L),[el,ei]=(0,l.useState)(!1),[ec,ed]=(0,l.useState)([]),[eu,eh]=(0,l.useState)([]),[ep,em]=(0,l.useState)(""),[eg,ey]=(0,l.useState)(!1),[ev,ex]=(0,l.useState)(!1),{t:ef}=(0,_.$G)(),[eb,eC]=(0,l.useState)(void 0!==J.env.NEXT_PUBLIC_BACKGROUND_IMAGE_PATH?J.env.NEXT_PUBLIC_BACKGROUND_IMAGE_PATH:"/bg-c.png"),[ej,ew]=(0,l.useState)(!1),[eS,ek]=(0,l.useState)(J.env.NEXT_PUBLIC_LOCAL_TTS_URL&&""!==J.env.NEXT_PUBLIC_LOCAL_TTS_URL?J.env.NEXT_PUBLIC_LOCAL_TTS_URL:"http://127.0.0.1:5000/tts"),[eN,eT]=(0,l.useState)(""),[eA,e_]=(0,l.useState)(2),[eL,eM]=(0,l.useState)(1),[eI,eP]=(0,l.useState)(""),[eR,eE]=(0,l.useState)(0),[eV,eB]=(0,l.useState)(0),[eO,eD]=(0,l.useState)(!1),[eU,eK]=(0,l.useState)(0),incrementChatProcessingCount=()=>{eK(e=>e+1)},decrementChatProcessingCount=()=>{eK(e=>e-1)};(0,l.useEffect)(()=>{let e=window.localStorage.getItem("chatVRMParams");if(e){let t=JSON.parse(e);n(t.userName||"きみ"),i(()=>SYSTEM_PROMPT(t.userName||"きみ")),er(t.koeiroParam||L),ed(Array.isArray(t.chatLog)?t.chatLog:[]),eh(Array.isArray(t.codeLog)?t.codeLog:[]),d(t.selectAIService||"openai"),h(t.selectAIModel||"gpt-4o"),m(t.openAiKey||""),y(t.anthropicKey||""),x(t.googleKey||""),b(t.groqKey||""),k(t.difyKey||""),A(t.difyUrl||""),I(t.selectVoice||"voicevox"),R(t.selectLanguage||"JP"),V(t.selectVoiceLanguage||"ja-JP"),O(t.koeiromapKey||""),U(t.voicevoxSpeaker||"2"),F(t.googleTtsType||"en-US-Neural2-F"),$(t.youtubeMode||!1),ee(t.youtubeApiKey||""),ea(t.youtubeLiveId||""),en(t.conversationContinuityMode||!1),ey(t.webSocketMode||!1),q(t.stylebertvits2ServerUrl||"http://127.0.0.1:5000"),W(t.stylebertvits2ModelId||"0"),X(t.stylebertvits2Style||"Neutral"),ew(t.dontShowIntroduction||!0),ek(t.gsviTtsServerUrl||"http://127.0.0.1:5000/tts"),eT(t.gsviTtsModelId||""),e_(t.gsviTtsBatchSize||2),eM(t.gsviTtsSpeechRate||1)}},[]),(0,l.useEffect)(()=>{let e={userName:s,systemPrompt:o,koeiroParam:eo,chatLog:ec,codeLog:eu,selectAIService:c,selectAIModel:u,openAiKey:p,anthropicKey:g,googleKey:v,groqKey:f,difyKey:w,difyUrl:N,selectVoice:M,selectLanguage:P,selectVoiceLanguage:E,koeiromapKey:B,voicevoxSpeaker:D,googleTtsType:G,youtubeMode:Z,youtubeApiKey:Q,youtubeLiveId:et,conversationContinuityMode:es,webSocketMode:eg,stylebertvits2ServerUrl:Y,stylebertvits2ModelId:z,stylebertvits2Style:H,dontShowIntroduction:ej,gsviTtsServerUrl:eS,gsviTtsModelId:eN,gsviTtsBatchSize:eA,gsviTtsSpeechRate:eL};J.nextTick(()=>window.localStorage.setItem("chatVRMParams",JSON.stringify(e)))},[s,o,eo,ec,eu,c,u,p,g,v,f,w,N,M,P,E,B,D,G,Z,Q,et,es,eg,Y,z,H,ej,eS,eN,eA,eL]);let eG=(0,l.useCallback)((e,a)=>{let s=ec.map((t,s)=>s===e?{role:t.role,content:a}:t);ed(s),t&&saveChatLog(t,s)},[ec,t]),eF=(0,l.useCallback)(async(e,t)=>{let a=eu.map((a,s)=>s===e?{role:a.role,content:t}:a);eh(a)},[eu]),eY=(0,l.useCallback)(async(t,a,s)=>{T(t,e,M,P,B,D,G,Y,z,H,eS,eN,eA,eL,a,s)},[e,M,P,B,D,G,Y,z,H,eS,eN,eA,eL]),eq=(0,l.useRef)(null),ez=(0,l.useCallback)(async(e,a)=>{let s;ei(!0);let n=p&&""!==p?p:"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",o=g&&""!==g?g:"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",r=v&&""!==v?v:"",l=C&&""!==C?C:"",i=u&&""!==u?u:"",d=f&&""!==f?f:"",h=w&&""!==w?w:"",m=N&&""!==N?N:"";try{"openai"===c?s=await getOpenAIChatResponseStream(a,n,u):"anthropic"===c?s=await getAnthropicChatResponseStream(a,o,u):"google"===c?s=await getGoogleChatResponseStream(a,r,u):"localLlm"===c?s=await getLocalLLMChatResponseStream(a,l,i):"groq"===c?s=await getGroqChatResponseStream(a,d,u):"dify"===c&&(s=await getDifyChatResponseStream(a,h,m))}catch(e){console.error(e),s=null}if(null==s){ei(!1);return}let y=s.getReader(),x="",b="",j="",S=[];try{for(;;){let{done:e,value:t}=await y.read();if(e)break;x+=t;let a=x.match(/^\[(.*?)\]/);a&&a[0]&&(j=a[0],x=x.slice(j.length));let s=x.match(/^(.+[。．！？\n]|.{10,}[、,])/);if(s&&s[0]){let e=s[0];if(S.push(e),x=x.slice(e.length).trimStart(),!e.replace(/^[\s\[\(\{「［（【『〈《〔｛«‹〘〚〛〙›»〕》〉』】）］」\}\)\]]+$/g,""))continue;let t="".concat(j," ").concat(e),a=textsToScreenplay([t],eo);b+=t;let n=S.join(" ");eY(a[0],()=>{em(n),incrementChatProcessingCount()},()=>{decrementChatProcessingCount()})}}}catch(e){console.error(e)}finally{y.releaseLock()}let k=[...e,{role:"assistant",content:b}];ed(k),ei(!1),t&&saveChatLog(t,k)},[c,p,u,g,v,C,f,w,N,eo,eY,t]),eJ=(0,l.useCallback)(async e=>{await ez(ec,e)},[ec,ez]),eW=(0,l.useCallback)(async(e,t)=>{if(null!=e){if(eg){if(console.log("websocket mode: true"),ei(!0),void 0!==t&&"user"!==t){if("assistant"==t){let t="[neutral] ".concat(e);try{let a=textsToScreenplay([t],eo);eY(a[0],async()=>{let t=[...eu,{role:"assistant",content:e}];ed(t),eh(t),em(e),ex(!1),ei(!1)})}catch(e){ex(!1),ei(!1)}}else if("code"==t||"output"==t||"executing"==t){let a=[...eu,{role:t,content:e}];eh(a),ei(!1)}else console.log("error role:",t)}else if(eq.current&&eq.current.readyState===WebSocket.OPEN){let t=[...eu,{role:"user",content:e}];ed(t),eh(t),eq.current.send(JSON.stringify({content:e,type:"chat"}))}else em(ef("NotConnectedToExternalAssistant")),ei(!1)}else{if("google"===c&&!v||"groq"===c&&!f||"dify"===c&&!w){em(ef("APIKeyNotEntered"));return}ei(!0);let t=[...ec,{role:"user",content:e}];ed(t);let a=[{role:"system",content:o},...t.slice(-10)];try{await ez(t,a)}catch(e){console.error(e)}ei(!1)}}},[eg,eo,eY,eu,ef,c,p,g,v,f,w,ec,o,ez]),[eH,eX]=(0,l.useState)([]);(0,l.useEffect)(()=>{let e=(0,K.v0)(),t=e.onAuthStateChanged(e=>{e?a(e.uid):a(null)});return()=>t()},[]),(0,l.useEffect)(()=>{let handleOpen=e=>{console.log("WebSocket connection opened:",e)},handleMessage=e=>{console.log("Received message:",e.data);let t=JSON.parse(e.data);eX(e=>[...e,t])},handleError=e=>{console.error("WebSocket error:",e)},handleClose=e=>{console.log("WebSocket connection closed:",e)};function setupWebsocket(){let e=new WebSocket("ws://localhost:8000/ws");return e.addEventListener("open",handleOpen),e.addEventListener("message",handleMessage),e.addEventListener("error",handleError),e.addEventListener("close",handleClose),e}let e=setupWebsocket();eq.current=e;let t=setInterval(()=>{eg&&e.readyState!==WebSocket.OPEN&&e.readyState!==WebSocket.CONNECTING&&(ei(!1),console.log("try reconnecting..."),e.close(),e=setupWebsocket(),eq.current=e)},1e3);return()=>{clearInterval(t),e.close()}},[eg]),(0,l.useEffect)(()=>{if(eH.length>0&&!ev){let e=eH[0];"assistant"==e.role&&ex(!0),eX(e=>e.slice(1)),eW(e.text,e.role)}},[eH,ev,eW]);let eZ=(0,l.useCallback)(async()=>{p&&et&&Q&&!el&&!(eU>0)&&(await new Promise(e=>setTimeout(e,5e3)),console.log("Call fetchAndProcessComments !!!"),fetchAndProcessComments(o,ec,p,u,et,Q,eI,eP,eV,eB,eR,eE,eO,eD,es,eW,eJ))},[p,u,et,Q,el,eU,o,ec,eI,eP,eV,eB,eR,eE,eO,eD,es,eW,eJ]);return(0,l.useEffect)(()=>{console.log("chatProcessingCount:",eU),eZ()},[eU,et,Q,es,eZ]),(0,l.useEffect)(()=>{eV<1||(console.log("youtubeSleepMode:",eO),setTimeout(()=>{eZ()},5e3))},[eV,es,eO,eZ]),(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{className:"font-M_PLUS_2",style:{backgroundImage:"url(".concat(buildUrl(eb),")"),backgroundSize:"cover",minHeight:"100vh"},children:[(0,r.jsx)(Meta,{}),!ej&&(0,r.jsx)(Introduction,{dontShowIntroduction:ej,onChangeDontShowIntroduction:ew,selectLanguage:P,setSelectLanguage:R,setSelectVoiceLanguage:V}),(0,r.jsx)(VrmViewer,{}),(0,r.jsx)(MessageInputContainer,{isChatProcessing:el,onChatProcessStart:eW,selectVoiceLanguage:E}),(0,r.jsx)(Menu,{selectAIService:c,onChangeAIService:d,selectAIModel:u,setSelectAIModel:h,userName:s,setUserName:n,openAiKey:p,onChangeOpenAiKey:m,anthropicKey:g,onChangeAnthropicKey:y,googleKey:v,onChangeGoogleKey:x,groqKey:f,onChangeGroqKey:b,localLlmUrl:C,onChangeLocalLlmUrl:j,difyKey:w,onChangeDifyKey:k,difyUrl:N,onChangeDifyUrl:A,systemPrompt:o,chatLog:ec,codeLog:eu,koeiroParam:eo,assistantMessage:ep,koeiromapKey:B,voicevoxSpeaker:D,googleTtsType:G,stylebertvits2ServerUrl:Y,stylebertvits2ModelId:z,stylebertvits2Style:H,youtubeMode:Z,youtubeApiKey:Q,youtubeLiveId:et,conversationContinuityMode:es,onChangeSystemPrompt:i,onChangeChatLog:eG,onChangeCodeLog:eF,onChangeKoeiromapParam:er,onChangeYoutubeMode:$,onChangeYoutubeApiKey:ee,onChangeYoutubeLiveId:ea,onChangeConversationContinuityMode:en,handleClickResetChatLog:()=>ed([]),handleClickResetCodeLog:()=>eh([]),handleClickResetSystemPrompt:()=>i(SYSTEM_PROMPT("きみ")),onChangeKoeiromapKey:O,onChangeVoicevoxSpeaker:U,onChangeGoogleTtsType:F,onChangeStyleBertVits2ServerUrl:q,onChangeStyleBertVits2ModelId:W,onChangeStyleBertVits2Style:X,webSocketMode:eg,changeWebSocketMode:ey,selectVoice:M,setSelectVoice:I,selectLanguage:P,setSelectLanguage:R,setSelectVoiceLanguage:V,setBackgroundImageUrl:eC,gsviTtsServerUrl:eS,onChangeGSVITtsServerUrl:ek,gsviTtsModelId:eN,onChangeGSVITtsModelId:eT,gsviTtsBatchSize:eA,onChangeGVITtsBatchSize:e_,gsviTtsSpeechRate:eL,onChangeGSVITtsSpeechRate:eM,setSystemPrompt:i})]})})}}},function(e){e.O(0,[3737,8086,2125,2513,9774,2888,179],function(){return e(e.s=8312)}),_N_E=e.O()}]);